<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samsung Heat Pump Settings Checker</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-800);
        }

        .privacy-notice {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .privacy-notice strong {
            color: var(--success);
        }

        .report-notice {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .report-notice strong {
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        input[type="text"], input[type="password"], select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--danger);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .error.active {
            display: block;
        }

        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-item {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
        }

        .info-item .label {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }

        .info-item .value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .info-item .value.on {
            color: var(--success);
        }

        .info-item .value.off {
            color: var(--gray-600);
        }

        .settings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .settings-table th,
        .settings-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .settings-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .settings-table tr:hover {
            background: var(--gray-50);
        }

        .category-header {
            background: var(--primary) !important;
            color: white !important;
        }

        .category-header th {
            color: white;
            background: transparent;
        }

        .recommendation {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .recommendation.good {
            background: #dcfce7;
            color: var(--success);
        }

        .recommendation.warning {
            background: #fef3c7;
            color: var(--warning);
        }

        .recommendation.info {
            background: #dbeafe;
            color: var(--primary);
        }

        .hidden {
            display: none !important;
        }

        .weather-curve {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .curve-visual {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .curve-point {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .curve-point .outdoor {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .curve-point .flow {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .curve-arrow {
            font-size: 1.5rem;
            color: var(--gray-400);
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .modal textarea {
            font-family: monospace;
            font-size: 0.85rem;
            min-height: 100px;
            margin-bottom: 1rem;
        }

        .copy-success {
            color: var(--success);
            font-size: 0.9rem;
            margin-left: 0.5rem;
            display: none;
        }

        .copy-success.show {
            display: inline;
        }

        footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .report-timestamp {
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .settings-table {
                font-size: 0.9rem;
            }

            .settings-table th,
            .settings-table td {
                padding: 0.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Samsung Heat Pump Settings Checker</h1>
            <p class="subtitle">View and analyse your Samsung EHS heat pump configuration</p>
        </header>

        <!-- Shared Report Notice (shown when viewing a shared report) -->
        <div class="report-notice hidden" id="report-notice">
            <strong>Viewing Shared Report</strong> - This is a snapshot of someone's heat pump settings.
            <br>To check your own heat pump, <a href="javascript:clearReport()">click here to start fresh</a>.
        </div>

        <!-- Token Entry -->
        <div class="card" id="token-card">
            <h2>Connect to SmartThings</h2>

            <div class="privacy-notice">
                <strong>100% Private</strong> - Your API token is processed entirely in your browser.
                It is never sent to any server other than SmartThings directly.
                You can verify this by inspecting the network requests in your browser's developer tools.
            </div>

            <div class="error" id="error-message"></div>

            <div class="form-group">
                <label for="token">SmartThings Personal Access Token</label>
                <input type="password" id="token" placeholder="Paste your token here..." autocomplete="off">
            </div>

            <p style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 1rem;">
                Get a token from <a href="https://account.smartthings.com/tokens" target="_blank">account.smartthings.com/tokens</a>
                <br>Required scopes: Devices (List, See)
            </p>

            <button class="btn btn-primary" id="connect-btn" onclick="connectToSmartThings()">
                Connect
            </button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>Connecting...</span>
            </div>
        </div>

        <!-- Device Selection (shown after connection) -->
        <div class="card hidden" id="device-card">
            <h2>Select Your Heat Pump</h2>

            <div class="form-group">
                <label for="device-select">Device</label>
                <select id="device-select" onchange="loadDeviceDetails()">
                    <option value="">Select a device...</option>
                </select>
            </div>

            <button class="btn btn-secondary" onclick="disconnect()">
                Disconnect
            </button>
        </div>

        <!-- Results -->
        <div class="hidden" id="results">
            <!-- Report timestamp (for shared reports) -->
            <div class="report-timestamp hidden" id="report-timestamp"></div>

            <!-- Share Button Card -->
            <div class="card" id="share-card">
                <h2>Share Your Settings</h2>
                <p style="color: var(--gray-600); margin-bottom: 1rem; font-size: 0.9rem;">
                    Generate a shareable link to get advice from others. The link contains only your settings - no API token.
                </p>
                <button class="btn btn-success" onclick="generateShareableReport()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                        <polyline points="16 6 12 2 8 6"></polyline>
                        <line x1="12" y1="2" x2="12" y2="15"></line>
                    </svg>
                    Generate Shareable Report
                </button>
            </div>

            <!-- Device Overview -->
            <div class="card">
                <h2>Device Overview</h2>
                <div class="device-info" id="device-overview"></div>
            </div>

            <!-- Current Status -->
            <div class="card">
                <h2>Current Status</h2>
                <div class="device-info" id="current-status"></div>
            </div>

            <!-- Weather Compensation -->
            <div class="card" id="weather-comp-card">
                <h2>Weather Compensation Curve</h2>
                <div class="weather-curve" id="weather-curve"></div>
            </div>

            <!-- FSV Settings -->
            <div class="card">
                <h2>Installer Settings (FSV Values)</h2>
                <p style="color: var(--gray-600); margin-bottom: 1rem; font-size: 0.9rem;">
                    These are the Field Service Values configured by your installer.
                    Recommendations are based on common best practices for UK climate.
                </p>
                <div style="overflow-x: auto;">
                    <table class="settings-table" id="fsv-table">
                        <thead>
                            <tr>
                                <th>FSV</th>
                                <th>Setting</th>
                                <th>Value</th>
                                <th>Range</th>
                                <th>Assessment</th>
                            </tr>
                        </thead>
                        <tbody id="fsv-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Power Consumption -->
            <div class="card" id="power-card">
                <h2>Energy Consumption</h2>
                <div class="device-info" id="power-info"></div>
            </div>
        </div>

        <footer>
            <p>
                This tool runs entirely in your browser.
                <a href="https://github.com/pookey/samsung-heatpump-smartthings" target="_blank">CLI tools available on GitHub</a>
            </p>
        </footer>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal">
        <div class="modal">
            <h3>Shareable Report Link</h3>
            <p style="color: var(--gray-600); margin-bottom: 1rem; font-size: 0.9rem;">
                Copy this link to share your heat pump settings. The link contains only your settings snapshot - no API token or personal data.
            </p>
            <textarea id="share-url" readonly onclick="this.select()"></textarea>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="copyShareUrl()">
                    Copy Link
                    <span class="copy-success" id="copy-success">Copied!</span>
                </button>
                <button class="btn btn-secondary" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // LZ-String compression (minimal implementation for URL-safe compression)
        const LZString = (function() {
            const keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
            const baseReverseDic = {};

            function getBaseValue(alphabet, character) {
                if (!baseReverseDic[alphabet]) {
                    baseReverseDic[alphabet] = {};
                    for (let i = 0; i < alphabet.length; i++) {
                        baseReverseDic[alphabet][alphabet.charAt(i)] = i;
                    }
                }
                return baseReverseDic[alphabet][character];
            }

            function compressToEncodedURIComponent(input) {
                if (input == null) return "";
                return _compress(input, 6, function(a) { return keyStrUriSafe.charAt(a); });
            }

            function decompressFromEncodedURIComponent(input) {
                if (input == null) return "";
                if (input == "") return null;
                input = input.replace(/ /g, "+");
                return _decompress(input.length, 32, function(index) { return getBaseValue(keyStrUriSafe, input.charAt(index)); });
            }

            function _compress(uncompressed, bitsPerChar, getCharFromInt) {
                if (uncompressed == null) return "";
                let i, value;
                const context_dictionary = {};
                const context_dictionaryToCreate = {};
                let context_c = "";
                let context_wc = "";
                let context_w = "";
                let context_enlargeIn = 2;
                let context_dictSize = 3;
                let context_numBits = 2;
                let context_data = [];
                let context_data_val = 0;
                let context_data_position = 0;

                for (let ii = 0; ii < uncompressed.length; ii++) {
                    context_c = uncompressed.charAt(ii);
                    if (!Object.prototype.hasOwnProperty.call(context_dictionary, context_c)) {
                        context_dictionary[context_c] = context_dictSize++;
                        context_dictionaryToCreate[context_c] = true;
                    }

                    context_wc = context_w + context_c;
                    if (Object.prototype.hasOwnProperty.call(context_dictionary, context_wc)) {
                        context_w = context_wc;
                    } else {
                        if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
                            if (context_w.charCodeAt(0) < 256) {
                                for (i = 0; i < context_numBits; i++) {
                                    context_data_val = (context_data_val << 1);
                                    if (context_data_position == bitsPerChar - 1) {
                                        context_data_position = 0;
                                        context_data.push(getCharFromInt(context_data_val));
                                        context_data_val = 0;
                                    } else {
                                        context_data_position++;
                                    }
                                }
                                value = context_w.charCodeAt(0);
                                for (i = 0; i < 8; i++) {
                                    context_data_val = (context_data_val << 1) | (value & 1);
                                    if (context_data_position == bitsPerChar - 1) {
                                        context_data_position = 0;
                                        context_data.push(getCharFromInt(context_data_val));
                                        context_data_val = 0;
                                    } else {
                                        context_data_position++;
                                    }
                                    value = value >> 1;
                                }
                            } else {
                                value = 1;
                                for (i = 0; i < context_numBits; i++) {
                                    context_data_val = (context_data_val << 1) | value;
                                    if (context_data_position == bitsPerChar - 1) {
                                        context_data_position = 0;
                                        context_data.push(getCharFromInt(context_data_val));
                                        context_data_val = 0;
                                    } else {
                                        context_data_position++;
                                    }
                                    value = 0;
                                }
                                value = context_w.charCodeAt(0);
                                for (i = 0; i < 16; i++) {
                                    context_data_val = (context_data_val << 1) | (value & 1);
                                    if (context_data_position == bitsPerChar - 1) {
                                        context_data_position = 0;
                                        context_data.push(getCharFromInt(context_data_val));
                                        context_data_val = 0;
                                    } else {
                                        context_data_position++;
                                    }
                                    value = value >> 1;
                                }
                            }
                            context_enlargeIn--;
                            if (context_enlargeIn == 0) {
                                context_enlargeIn = Math.pow(2, context_numBits);
                                context_numBits++;
                            }
                            delete context_dictionaryToCreate[context_w];
                        } else {
                            value = context_dictionary[context_w];
                            for (i = 0; i < context_numBits; i++) {
                                context_data_val = (context_data_val << 1) | (value & 1);
                                if (context_data_position == bitsPerChar - 1) {
                                    context_data_position = 0;
                                    context_data.push(getCharFromInt(context_data_val));
                                    context_data_val = 0;
                                } else {
                                    context_data_position++;
                                }
                                value = value >> 1;
                            }
                        }
                        context_enlargeIn--;
                        if (context_enlargeIn == 0) {
                            context_enlargeIn = Math.pow(2, context_numBits);
                            context_numBits++;
                        }
                        context_dictionary[context_wc] = context_dictSize++;
                        context_w = String(context_c);
                    }
                }

                if (context_w !== "") {
                    if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
                        if (context_w.charCodeAt(0) < 256) {
                            for (i = 0; i < context_numBits; i++) {
                                context_data_val = (context_data_val << 1);
                                if (context_data_position == bitsPerChar - 1) {
                                    context_data_position = 0;
                                    context_data.push(getCharFromInt(context_data_val));
                                    context_data_val = 0;
                                } else {
                                    context_data_position++;
                                }
                            }
                            value = context_w.charCodeAt(0);
                            for (i = 0; i < 8; i++) {
                                context_data_val = (context_data_val << 1) | (value & 1);
                                if (context_data_position == bitsPerChar - 1) {
                                    context_data_position = 0;
                                    context_data.push(getCharFromInt(context_data_val));
                                    context_data_val = 0;
                                } else {
                                    context_data_position++;
                                }
                                value = value >> 1;
                            }
                        } else {
                            value = 1;
                            for (i = 0; i < context_numBits; i++) {
                                context_data_val = (context_data_val << 1) | value;
                                if (context_data_position == bitsPerChar - 1) {
                                    context_data_position = 0;
                                    context_data.push(getCharFromInt(context_data_val));
                                    context_data_val = 0;
                                } else {
                                    context_data_position++;
                                }
                                value = 0;
                            }
                            value = context_w.charCodeAt(0);
                            for (i = 0; i < 16; i++) {
                                context_data_val = (context_data_val << 1) | (value & 1);
                                if (context_data_position == bitsPerChar - 1) {
                                    context_data_position = 0;
                                    context_data.push(getCharFromInt(context_data_val));
                                    context_data_val = 0;
                                } else {
                                    context_data_position++;
                                }
                                value = value >> 1;
                            }
                        }
                        context_enlargeIn--;
                        if (context_enlargeIn == 0) {
                            context_enlargeIn = Math.pow(2, context_numBits);
                            context_numBits++;
                        }
                        delete context_dictionaryToCreate[context_w];
                    } else {
                        value = context_dictionary[context_w];
                        for (i = 0; i < context_numBits; i++) {
                            context_data_val = (context_data_val << 1) | (value & 1);
                            if (context_data_position == bitsPerChar - 1) {
                                context_data_position = 0;
                                context_data.push(getCharFromInt(context_data_val));
                                context_data_val = 0;
                            } else {
                                context_data_position++;
                            }
                            value = value >> 1;
                        }
                    }
                    context_enlargeIn--;
                    if (context_enlargeIn == 0) {
                        context_enlargeIn = Math.pow(2, context_numBits);
                        context_numBits++;
                    }
                }

                value = 2;
                for (i = 0; i < context_numBits; i++) {
                    context_data_val = (context_data_val << 1) | (value & 1);
                    if (context_data_position == bitsPerChar - 1) {
                        context_data_position = 0;
                        context_data.push(getCharFromInt(context_data_val));
                        context_data_val = 0;
                    } else {
                        context_data_position++;
                    }
                    value = value >> 1;
                }

                while (true) {
                    context_data_val = (context_data_val << 1);
                    if (context_data_position == bitsPerChar - 1) {
                        context_data.push(getCharFromInt(context_data_val));
                        break;
                    } else {
                        context_data_position++;
                    }
                }
                return context_data.join('');
            }

            function _decompress(length, resetValue, getNextValue) {
                const dictionary = [];
                let enlargeIn = 4;
                let dictSize = 4;
                let numBits = 3;
                let entry = "";
                let result = [];
                let i;
                let w;
                let c;
                let data = { val: getNextValue(0), position: resetValue, index: 1 };

                for (i = 0; i < 3; i++) {
                    dictionary[i] = i;
                }

                let bits = 0;
                let maxpower = Math.pow(2, 2);
                let power = 1;
                while (power != maxpower) {
                    let resb = data.val & data.position;
                    data.position >>= 1;
                    if (data.position == 0) {
                        data.position = resetValue;
                        data.val = getNextValue(data.index++);
                    }
                    bits |= (resb > 0 ? 1 : 0) * power;
                    power <<= 1;
                }

                const next = bits;
                switch (next) {
                    case 0:
                        bits = 0;
                        maxpower = Math.pow(2, 8);
                        power = 1;
                        while (power != maxpower) {
                            let resb = data.val & data.position;
                            data.position >>= 1;
                            if (data.position == 0) {
                                data.position = resetValue;
                                data.val = getNextValue(data.index++);
                            }
                            bits |= (resb > 0 ? 1 : 0) * power;
                            power <<= 1;
                        }
                        c = String.fromCharCode(bits);
                        break;
                    case 1:
                        bits = 0;
                        maxpower = Math.pow(2, 16);
                        power = 1;
                        while (power != maxpower) {
                            let resb = data.val & data.position;
                            data.position >>= 1;
                            if (data.position == 0) {
                                data.position = resetValue;
                                data.val = getNextValue(data.index++);
                            }
                            bits |= (resb > 0 ? 1 : 0) * power;
                            power <<= 1;
                        }
                        c = String.fromCharCode(bits);
                        break;
                    case 2:
                        return "";
                }
                dictionary[3] = c;
                w = c;
                result.push(c);
                while (true) {
                    if (data.index > length) {
                        return "";
                    }

                    bits = 0;
                    maxpower = Math.pow(2, numBits);
                    power = 1;
                    while (power != maxpower) {
                        let resb = data.val & data.position;
                        data.position >>= 1;
                        if (data.position == 0) {
                            data.position = resetValue;
                            data.val = getNextValue(data.index++);
                        }
                        bits |= (resb > 0 ? 1 : 0) * power;
                        power <<= 1;
                    }

                    switch (c = bits) {
                        case 0:
                            bits = 0;
                            maxpower = Math.pow(2, 8);
                            power = 1;
                            while (power != maxpower) {
                                let resb = data.val & data.position;
                                data.position >>= 1;
                                if (data.position == 0) {
                                    data.position = resetValue;
                                    data.val = getNextValue(data.index++);
                                }
                                bits |= (resb > 0 ? 1 : 0) * power;
                                power <<= 1;
                            }
                            dictionary[dictSize++] = String.fromCharCode(bits);
                            c = dictSize - 1;
                            enlargeIn--;
                            break;
                        case 1:
                            bits = 0;
                            maxpower = Math.pow(2, 16);
                            power = 1;
                            while (power != maxpower) {
                                let resb = data.val & data.position;
                                data.position >>= 1;
                                if (data.position == 0) {
                                    data.position = resetValue;
                                    data.val = getNextValue(data.index++);
                                }
                                bits |= (resb > 0 ? 1 : 0) * power;
                                power <<= 1;
                            }
                            dictionary[dictSize++] = String.fromCharCode(bits);
                            c = dictSize - 1;
                            enlargeIn--;
                            break;
                        case 2:
                            return result.join('');
                    }

                    if (enlargeIn == 0) {
                        enlargeIn = Math.pow(2, numBits);
                        numBits++;
                    }

                    if (dictionary[c]) {
                        entry = dictionary[c];
                    } else {
                        if (c === dictSize) {
                            entry = w + w.charAt(0);
                        } else {
                            return null;
                        }
                    }
                    result.push(entry);
                    dictionary[dictSize++] = w + entry.charAt(0);
                    enlargeIn--;
                    if (enlargeIn == 0) {
                        enlargeIn = Math.pow(2, numBits);
                        numBits++;
                    }
                    w = entry;
                }
            }

            return {
                compressToEncodedURIComponent: compressToEncodedURIComponent,
                decompressFromEncodedURIComponent: decompressFromEncodedURIComponent
            };
        })();

        // SmartThings API
        const API_BASE = 'https://api.smartthings.com/v1';
        let currentToken = null;
        let currentDevices = [];
        let currentReportData = null;

        // FSV Settings Reference
        const FSV_SETTINGS = {
            "1031": { name: "Heating Water Temp Upper Limit", category: "Temperature Limits", unit: "°C", recommend: (v) => v >= 45 && v <= 55 ? "good" : v > 55 ? "warning" : null, recommendText: (v) => v > 55 ? "Consider lowering for better efficiency" : v < 45 ? "May be too low for radiators" : "Good for efficiency" },
            "1032": { name: "Heating Water Temp Lower Limit", category: "Temperature Limits", unit: "°C", recommend: (v) => v >= 25 && v <= 35 ? "good" : null, recommendText: (v) => "OK" },
            "1051": { name: "DHW Tank Temp Upper Limit", category: "DHW Settings", unit: "°C", recommend: (v) => v >= 48 && v <= 55 ? "good" : v > 60 ? "warning" : null, recommendText: (v) => v > 60 ? "High - increases energy use" : v < 48 ? "Check legionella requirements" : "Good balance of safety and efficiency" },
            "1052": { name: "DHW Tank Temp Lower Limit", category: "DHW Settings", unit: "°C", recommend: (v) => v >= 40 && v <= 45 ? "good" : v < 40 ? "warning" : null, recommendText: (v) => v < 40 ? "May be too low - legionella risk" : "OK" },
            "2011": { name: "WC: Low Outside Temp Point", category: "Weather Compensation", unit: "°C", recommend: (v) => v >= -5 && v <= 0 ? "good" : v < -10 ? "info" : null, recommendText: (v) => v < -10 ? "Very cold design temp" : "Typical UK setting" },
            "2012": { name: "WC: High Outside Temp Point", category: "Weather Compensation", unit: "°C", recommend: (v) => v >= 15 && v <= 18 ? "good" : v > 20 ? "info" : null, recommendText: (v) => v > 20 ? "High - heating may run when not needed" : "Typical setting" },
            "2021": { name: "WC: Flow Temp at Low Outside Temp", category: "Weather Compensation", unit: "°C", recommend: (v) => v >= 35 && v <= 45 ? "good" : v > 50 ? "warning" : null, recommendText: (v) => v > 50 ? "High - reduces efficiency" : v < 35 ? "May not heat adequately" : "Good for efficiency" },
            "2022": { name: "WC: Flow Temp at High Outside Temp", category: "Weather Compensation", unit: "°C", recommend: (v) => v >= 25 && v <= 35 ? "good" : v > 40 ? "warning" : null, recommendText: (v) => v > 40 ? "High for mild weather" : "Good" },
            "2031": { name: "WC Zone2: Flow Temp at Low Outside Temp", category: "Weather Compensation", unit: "°C" },
            "2032": { name: "WC Zone2: Flow Temp at High Outside Temp", category: "Weather Compensation", unit: "°C" },
            "2091": { name: "Zone 1 Thermostat Control", category: "Control Settings", values: {0: "None", 1: "Thermostat on/off", 2: "Thermostat on/off (alt)", 3: "With water law", 4: "With water law (alt)"} },
            "2092": { name: "Zone 2 Thermostat Control", category: "Control Settings", values: {0: "None", 1: "Thermostat on/off", 2: "Thermostat on/off (alt)", 3: "With water law", 4: "With water law (alt)"} },
            "2093": { name: "Cycling Behaviour", category: "Control Settings", values: {1: "No cycling (continuous)", 2: "Cycles (short)", 3: "Cycles (medium)", 4: "Cycles (long)"}, recommend: (v) => v === 1 ? "good" : v >= 2 ? "info" : null, recommendText: (v) => v === 1 ? "Best for efficiency" : "Cycling mode" },
            "3011": { name: "DHW Operation Mode", category: "DHW Settings", values: {0: "Disabled", 1: "Eco (hysteresis)", 2: "Standard"}, recommend: (v) => v === 1 ? "good" : v === 2 ? "info" : null, recommendText: (v) => v === 1 ? "Eco mode - efficient" : v === 2 ? "Standard mode" : "DHW disabled" },
            "3071": { name: "3-Way Valve Direction", category: "DHW Settings", values: {0: "Normal", 1: "Reversed"} },
            "4011": { name: "DHW/Heating Priority", category: "System Settings", values: {0: "DHW Priority", 1: "Heating Priority"}, recommend: (v) => v === 0 ? "good" : null, recommendText: (v) => v === 0 ? "Typical setting" : "Heating priority" },
            "4012": { name: "Heating Priority Temp Threshold", category: "System Settings", unit: "°C" },
            "4021": { name: "Backup Heater for Space Heating", category: "System Settings", values: {0: "Disabled", 1: "Enabled", 2: "Emergency only"}, recommend: (v) => v === 0 ? "good" : v === 1 ? "warning" : null, recommendText: (v) => v === 0 ? "Good - maximises efficiency" : v === 1 ? "May increase costs" : "Emergency only" },
            "4042": { name: "Mixing Valve Temp Difference", category: "System Settings", unit: "°C" },
            "4061": { name: "Zone Control Enable", category: "System Settings", values: {0: "Disabled", 1: "Enabled"} }
        };

        // Check for shared report on page load
        window.addEventListener('load', function() {
            if (window.location.hash && window.location.hash.length > 1) {
                try {
                    const compressed = window.location.hash.substring(1);
                    const json = LZString.decompressFromEncodedURIComponent(compressed);
                    if (json) {
                        const reportData = JSON.parse(json);
                        displaySharedReport(reportData);
                    }
                } catch (e) {
                    console.error('Failed to load shared report:', e);
                }
            }
        });

        function displaySharedReport(data) {
            currentReportData = data;

            document.getElementById('token-card').classList.add('hidden');
            document.getElementById('device-card').classList.add('hidden');
            document.getElementById('report-notice').classList.remove('hidden');
            document.getElementById('share-card').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');

            // Show timestamp
            if (data.timestamp) {
                const date = new Date(data.timestamp);
                document.getElementById('report-timestamp').textContent = `Report generated: ${date.toLocaleString()}`;
                document.getElementById('report-timestamp').classList.remove('hidden');
            }

            // Display device overview
            document.getElementById('device-overview').innerHTML = `
                <div class="info-item"><div class="label">Device Name</div><div class="value">${data.device?.name || 'Samsung EHS'}</div></div>
                <div class="info-item"><div class="label">Model</div><div class="value">${data.device?.model || 'Unknown'}</div></div>
                <div class="info-item"><div class="label">Manufacturer</div><div class="value">${data.device?.manufacturer || 'Samsung'}</div></div>
            `;

            // Display current status
            displayCurrentStatusFromData(data.status);

            // Display weather curve
            displayWeatherCurveFromData(data.fsv);

            // Display FSV settings
            displayFSVSettingsFromData(data.fsv);

            // Display power info
            if (data.power) {
                displayPowerInfoFromData(data.power);
            } else {
                document.getElementById('power-card').classList.add('hidden');
            }
        }

        function clearReport() {
            window.location.hash = '';
            window.location.reload();
        }

        // API Functions
        async function apiRequest(endpoint) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                headers: { 'Authorization': `Bearer ${currentToken}`, 'Accept': 'application/json' }
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `API Error: ${response.status}`);
            }
            return response.json();
        }

        async function connectToSmartThings() {
            const tokenInput = document.getElementById('token');
            const errorDiv = document.getElementById('error-message');
            const loadingDiv = document.getElementById('loading');
            const connectBtn = document.getElementById('connect-btn');

            currentToken = tokenInput.value.trim();
            if (!currentToken) { showError('Please enter your SmartThings token'); return; }

            errorDiv.classList.remove('active');
            loadingDiv.classList.add('active');
            connectBtn.disabled = true;

            try {
                const data = await apiRequest('/devices');
                currentDevices = data.items || [];

                const hvacDevices = currentDevices.filter(d => {
                    const name = (d.label || d.name || '').toLowerCase();
                    const manufacturer = (d.manufacturerName || '').toLowerCase();
                    const hasHvacCaps = (d.components || []).some(c => (c.capabilities || []).some(cap => ['thermostatMode', 'airConditionerMode', 'thermostatCoolingSetpoint'].includes(cap.id)));
                    return hasHvacCaps || manufacturer.includes('samsung') || name.includes('heat') || name.includes('pump') || name.includes('ehs');
                });

                populateDeviceSelect(hvacDevices.length > 0 ? hvacDevices : currentDevices);
                if (currentDevices.length === 0) throw new Error('No devices found');

                document.getElementById('token-card').classList.add('hidden');
                document.getElementById('device-card').classList.remove('hidden');
            } catch (err) {
                showError(err.message);
            } finally {
                loadingDiv.classList.remove('active');
                connectBtn.disabled = false;
            }
        }

        function populateDeviceSelect(devices) {
            const select = document.getElementById('device-select');
            select.innerHTML = '<option value="">Select a device...</option>';
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.textContent = `${device.label || device.name} (${device.manufacturerName || 'Unknown'})`;
                select.appendChild(option);
            });
            if (devices.length === 1) { select.value = devices[0].deviceId; loadDeviceDetails(); }
        }

        async function loadDeviceDetails() {
            const deviceId = document.getElementById('device-select').value;
            if (!deviceId) { document.getElementById('results').classList.add('hidden'); return; }

            try {
                const [device, status] = await Promise.all([apiRequest(`/devices/${deviceId}`), apiRequest(`/devices/${deviceId}/status`)]);
                currentReportData = buildReportData(device, status);
                displayResults(device, status);
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('share-card').classList.remove('hidden');
                document.getElementById('report-timestamp').classList.add('hidden');
            } catch (err) {
                showError(err.message);
            }
        }

        function buildReportData(device, status) {
            const fsvData = status.components?.main?.['samsungce.ehsFsvSettings']?.fsvSettings?.value || [];
            const fsvMap = {};
            fsvData.forEach(f => fsvMap[f.id] = { value: f.value, min: f.minValue, max: f.maxValue, unit: f.temperatureUnit });

            const powerData = status.components?.main?.powerConsumptionReport?.powerConsumption?.value;

            return {
                timestamp: new Date().toISOString(),
                device: {
                    name: device.label || device.name,
                    model: device.name,
                    manufacturer: device.manufacturerName
                },
                status: {
                    mainSwitch: status.components?.main?.switch?.switch?.value,
                    indoorSwitch: status.components?.INDOOR1?.switch?.switch?.value,
                    mainTemp: status.components?.main?.temperatureMeasurement?.temperature?.value,
                    indoorTemp: status.components?.INDOOR1?.temperatureMeasurement?.temperature?.value,
                    setpoint: status.components?.INDOOR1?.thermostatCoolingSetpoint?.coolingSetpoint?.value,
                    mode: status.components?.INDOOR1?.airConditionerMode?.airConditionerMode?.value,
                    effMode: status.components?.main?.airConditionerMode?.airConditionerMode?.value
                },
                fsv: fsvMap,
                power: powerData ? { energy: powerData.energy, power: powerData.power } : null
            };
        }

        function displayResults(device, status) {
            document.getElementById('device-overview').innerHTML = `
                <div class="info-item"><div class="label">Device Name</div><div class="value">${device.label || device.name}</div></div>
                <div class="info-item"><div class="label">Model</div><div class="value">${device.name || 'Samsung EHS'}</div></div>
                <div class="info-item"><div class="label">Manufacturer</div><div class="value">${device.manufacturerName || 'Samsung'}</div></div>
                <div class="info-item"><div class="label">Components</div><div class="value">${(device.components || []).map(c => c.id).join(', ')}</div></div>
            `;
            displayCurrentStatus(status);
            displayWeatherCurve(status);
            displayFSVSettings(status);
            displayPowerInfo(status);
        }

        function displayCurrentStatus(status) {
            const c = status.components || {};
            let html = '';
            if (c.main?.switch?.switch?.value !== undefined) html += `<div class="info-item"><div class="label">Main Power</div><div class="value ${c.main.switch.switch.value}">${c.main.switch.switch.value.toUpperCase()}</div></div>`;
            if (c.INDOOR1?.switch?.switch?.value !== undefined) html += `<div class="info-item"><div class="label">Heating Circuit</div><div class="value ${c.INDOOR1.switch.switch.value}">${c.INDOOR1.switch.switch.value.toUpperCase()}</div></div>`;
            if (c.main?.temperatureMeasurement?.temperature?.value !== undefined) html += `<div class="info-item"><div class="label">Water Temperature</div><div class="value">${c.main.temperatureMeasurement.temperature.value}°C</div></div>`;
            if (c.INDOOR1?.temperatureMeasurement?.temperature?.value !== undefined) html += `<div class="info-item"><div class="label">Flow Temperature</div><div class="value">${c.INDOOR1.temperatureMeasurement.temperature.value}°C</div></div>`;
            if (c.INDOOR1?.thermostatCoolingSetpoint?.coolingSetpoint?.value !== undefined) html += `<div class="info-item"><div class="label">Target Flow Temp</div><div class="value">${c.INDOOR1.thermostatCoolingSetpoint.coolingSetpoint.value}°C</div></div>`;
            if (c.INDOOR1?.airConditionerMode?.airConditionerMode?.value) html += `<div class="info-item"><div class="label">Operating Mode</div><div class="value">${c.INDOOR1.airConditionerMode.airConditionerMode.value.charAt(0).toUpperCase() + c.INDOOR1.airConditionerMode.airConditionerMode.value.slice(1)}</div></div>`;
            if (c.main?.airConditionerMode?.airConditionerMode?.value) html += `<div class="info-item"><div class="label">Efficiency Mode</div><div class="value">${c.main.airConditionerMode.airConditionerMode.value.toUpperCase()}</div></div>`;
            document.getElementById('current-status').innerHTML = html || '<p>No status data available</p>';
        }

        function displayCurrentStatusFromData(s) {
            let html = '';
            if (s.mainSwitch !== undefined) html += `<div class="info-item"><div class="label">Main Power</div><div class="value ${s.mainSwitch}">${s.mainSwitch.toUpperCase()}</div></div>`;
            if (s.indoorSwitch !== undefined) html += `<div class="info-item"><div class="label">Heating Circuit</div><div class="value ${s.indoorSwitch}">${s.indoorSwitch.toUpperCase()}</div></div>`;
            if (s.mainTemp !== undefined) html += `<div class="info-item"><div class="label">Water Temperature</div><div class="value">${s.mainTemp}°C</div></div>`;
            if (s.indoorTemp !== undefined) html += `<div class="info-item"><div class="label">Flow Temperature</div><div class="value">${s.indoorTemp}°C</div></div>`;
            if (s.setpoint !== undefined) html += `<div class="info-item"><div class="label">Target Flow Temp</div><div class="value">${s.setpoint}°C</div></div>`;
            if (s.mode) html += `<div class="info-item"><div class="label">Operating Mode</div><div class="value">${s.mode.charAt(0).toUpperCase() + s.mode.slice(1)}</div></div>`;
            if (s.effMode) html += `<div class="info-item"><div class="label">Efficiency Mode</div><div class="value">${s.effMode.toUpperCase()}</div></div>`;
            document.getElementById('current-status').innerHTML = html || '<p>No status data available</p>';
        }

        function displayWeatherCurve(status) {
            const fsvData = status.components?.main?.['samsungce.ehsFsvSettings']?.fsvSettings?.value || [];
            const fsvMap = {}; fsvData.forEach(f => fsvMap[f.id] = f.value);
            displayWeatherCurveFromData(fsvMap);
        }

        function displayWeatherCurveFromData(fsvMap) {
            const lowOut = fsvMap['2011']?.value ?? fsvMap['2011'];
            const highOut = fsvMap['2012']?.value ?? fsvMap['2012'];
            const lowFlow = fsvMap['2021']?.value ?? fsvMap['2021'];
            const highFlow = fsvMap['2022']?.value ?? fsvMap['2022'];

            if (lowOut !== undefined && highOut !== undefined && lowFlow !== undefined && highFlow !== undefined) {
                document.getElementById('weather-curve').innerHTML = `
                    <p style="margin-bottom: 1rem; color: var(--gray-600);">Your heating curve adjusts flow temperature based on outside temperature:</p>
                    <div class="curve-visual">
                        <div class="curve-point"><div class="outdoor">When outside is ${lowOut}°C</div><div class="flow">${lowFlow}°C</div><div class="outdoor">flow temperature</div></div>
                        <div class="curve-arrow">→</div>
                        <div class="curve-point"><div class="outdoor">When outside is ${highOut}°C</div><div class="flow">${highFlow}°C</div><div class="outdoor">flow temperature</div></div>
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--gray-600);">${getWeatherCurveRecommendation(lowOut, highOut, lowFlow, highFlow)}</p>
                `;
                document.getElementById('weather-comp-card').classList.remove('hidden');
            } else {
                document.getElementById('weather-comp-card').classList.add('hidden');
            }
        }

        function getWeatherCurveRecommendation(lowOut, highOut, lowFlow, highFlow) {
            const r = [];
            if (lowFlow > 50) r.push(`Max flow temp (${lowFlow}°C) is high. For UFH 35-45°C is typical.`);
            if (highFlow > 35) r.push(`Min flow temp (${highFlow}°C) could be lower in mild weather.`);
            if (lowFlow <= 45 && highFlow <= 35) r.push("Curve looks well-optimised for efficiency.");
            return r.join(' ') || "Weather compensation configured.";
        }

        function displayFSVSettings(status) {
            const fsvData = status.components?.main?.['samsungce.ehsFsvSettings']?.fsvSettings?.value || [];
            const fsvMap = {}; fsvData.forEach(f => fsvMap[f.id] = { value: f.value, min: f.minValue, max: f.maxValue, unit: f.temperatureUnit });
            displayFSVSettingsFromData(fsvMap);
        }

        function displayFSVSettingsFromData(fsvMap) {
            const tbody = document.getElementById('fsv-tbody');
            if (Object.keys(fsvMap).length === 0) { tbody.innerHTML = '<tr><td colspan="5">No FSV settings available</td></tr>'; return; }

            const categories = {};
            Object.entries(fsvMap).forEach(([id, data]) => {
                const info = FSV_SETTINGS[id] || { name: `Unknown (${id})`, category: 'Other' };
                const cat = info.category || 'Other';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push({ id, data: typeof data === 'object' ? data : { value: data }, info });
            });

            let html = '';
            ['Temperature Limits', 'Weather Compensation', 'Control Settings', 'DHW Settings', 'System Settings', 'Other'].forEach(cat => {
                if (!categories[cat]) return;
                html += `<tr class="category-header"><th colspan="5">${cat}</th></tr>`;
                categories[cat].sort((a, b) => a.id.localeCompare(b.id)).forEach(({ id, data, info }) => {
                    let val = data.value;
                    let unit = data.unit ? `°${data.unit}` : (info.unit || '');
                    let valueDisplay = info.values && info.values[val] !== undefined ? `${val} (${info.values[val]})` : `${val}${unit}`;
                    let rec = '';
                    if (info.recommend) {
                        const level = info.recommend(val);
                        const text = info.recommendText ? info.recommendText(val) : '';
                        if (level && text) rec = `<span class="recommendation ${level}">${text}</span>`;
                    }
                    const range = data.min !== undefined ? `${data.min} - ${data.max}${unit}` : '-';
                    html += `<tr><td><strong>${id}</strong></td><td>${info.name}</td><td>${valueDisplay}</td><td>${range}</td><td>${rec}</td></tr>`;
                });
            });
            tbody.innerHTML = html;
        }

        function displayPowerInfo(status) {
            const p = status.components?.main?.powerConsumptionReport?.powerConsumption?.value;
            if (!p) { document.getElementById('power-card').classList.add('hidden'); return; }
            displayPowerInfoFromData(p);
        }

        function displayPowerInfoFromData(p) {
            document.getElementById('power-card').classList.remove('hidden');
            document.getElementById('power-info').innerHTML = `
                <div class="info-item"><div class="label">Total Energy Used</div><div class="value">${(p.energy / 1000).toFixed(1)} kWh</div></div>
                <div class="info-item"><div class="label">Current Power</div><div class="value">${p.power || 0} W</div></div>
            `;
        }

        function generateShareableReport() {
            if (!currentReportData) { alert('No data to share'); return; }
            const json = JSON.stringify(currentReportData);
            const compressed = LZString.compressToEncodedURIComponent(json);
            const url = `${window.location.origin}${window.location.pathname}#${compressed}`;

            document.getElementById('share-url').value = url;
            document.getElementById('share-modal').classList.add('active');
            document.getElementById('copy-success').classList.remove('show');
        }

        function copyShareUrl() {
            const textarea = document.getElementById('share-url');
            textarea.select();
            document.execCommand('copy');
            document.getElementById('copy-success').classList.add('show');
            setTimeout(() => document.getElementById('copy-success').classList.remove('show'), 2000);
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        function disconnect() {
            currentToken = null;
            currentDevices = [];
            currentReportData = null;
            document.getElementById('token').value = '';
            document.getElementById('device-select').innerHTML = '<option value="">Select a device...</option>';
            document.getElementById('token-card').classList.remove('hidden');
            document.getElementById('device-card').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('error-message').classList.remove('active');
        }

        document.getElementById('token').addEventListener('keypress', function(e) { if (e.key === 'Enter') connectToSmartThings(); });
        document.getElementById('share-modal').addEventListener('click', function(e) { if (e.target === this) closeShareModal(); });
    </script>
</body>
</html>
